---
title: Workflow 4.1 Beta发布：采用事件溯源架构，提升可靠性与吞吐量
title_original: 'Workflow 4.1 Beta: Event-sourced architecture - Vercel'
date: '2026-02-03'
source: Vercel Blog
source_url: https://vercel.com/changelog/workflow-event-sourcing
author: ''
summary: Workflow 4.1 Beta版本核心更新是引入了事件溯源架构，将工作流状态变更存储为不可变的事件序列，而非原地更新记录。这一改变带来了三大优势：系统具备自我修复能力，可自动从队列消息丢失等故障中恢复；提供完整的审计追踪，便于调试；确保数据一致性，事件日志成为唯一真相来源。此外，新版本还显著提高了吞吐量，支持每秒处理数千个步骤，并新增了对供应商执行工具、NestJS框架集成、TC39显式资源管理等功能的支持。
categories:
- AI基础设施
tags:
- 事件溯源
- 工作流引擎
- 系统架构
- Vercel
- 开发者工具
draft: false
translated_at: '2026-02-05T04:16:57.908383'
---

Workflow 4.1 Beta 改变了工作流在内部跟踪状态的方式。现在，每次状态变更都作为事件存储，而不是原地更新记录，当前状态通过重放日志来重建。此版本还增加了对供应商执行工具和更高吞吐量的支持。

## 事件溯源对工作流意味着什么

事件溯源是一种持久化模式，其中状态变更被存储为一系列事件，而不是通过原地更新记录。系统不存储"此运行已完成"，而是存储"run_created，然后 run_started，然后 run_completed"，并通过重放这些事件来重建当前状态。

在 Workflow 4.1 中，运行、步骤和钩子不再是可变的数据库记录。它们是仅追加事件日志的具体化体现。每个事件都捕获了时间戳和上下文，运行时通过按顺序处理事件来推导当前状态。

这种架构通过三种方式使工作流更可靠：

- **自我修复**：如果队列消息丢失或发生竞态条件，重放工作流路由会检测到缺失的状态，并重新将必要的消息加入队列。旧版本运行需要手动干预才能从队列停机中恢复；新版本运行可自动恢复。
- **完整的审计追踪**：事件日志允许您重放导致任何状态的确切序列，这使得调试分布式工作流变得更加容易。
- **一致性**：事件是仅追加的，因此写入过程中的部分失败不会使实体处于不一致的状态。事件日志是唯一的真相来源。

**自我修复**：如果队列消息丢失或发生竞态条件，重放工作流路由会检测到缺失的状态，并重新将必要的消息加入队列。旧版本运行需要手动干预才能从队列停机中恢复；新版本运行可自动恢复。

**完整的审计追踪**：事件日志允许您重放导致任何状态的确切序列，这使得调试分布式工作流变得更加容易。

**一致性**：事件是仅追加的，因此写入过程中的部分失败不会使实体处于不一致的状态。事件日志是唯一的真相来源。

要更深入地了解事件模型，包括运行、步骤和钩子生命周期的状态机图，请参阅[事件溯源文档](https://docs.workflow.com/events)。

## 其他更新

- **提高的吞吐量**：工作流队列系统现在每秒可处理数千个步骤。当依赖关系允许时，多个步骤并行执行。
- **供应商执行工具**：`@workflow/ai` 现在支持供应商执行工具，如 Google Search 和 WebSearch，这些工具在模型供应商的基础设施上运行，而不是在您的工作流中运行。
- **NestJS 支持**：新的 `@workflow/nest` 包增加了对 NestJS 应用程序的构建支持，处理依赖注入模式，使工作流能够与现有的 NestJS 服务集成。
- **顶级 `using` 声明**：SWC 插件现在支持在步骤和工作流函数内部使用 TC39 显式资源管理提案，从而实现自动资源清理。
- **自定义类序列化**：客户端模式现在支持自定义类序列化，通过 `manifest.json` 中的 `classes` 对象来声明可序列化的类型。
- **修复了 `@workflow/ai` 中工具输出的双重序列化问题**

**提高的吞吐量**：工作流队列系统现在每秒可处理数千个步骤。当依赖关系允许时，多个步骤并行执行。

**供应商执行工具**：`@workflow/ai` 现在支持供应商执行工具，如 Google Search 和 WebSearch，这些工具在模型供应商的基础设施上运行，而不是在您的工作流中运行。

**NestJS 支持**：新的 `@workflow/nest` 包增加了对 NestJS 应用程序的构建支持，处理依赖注入模式，使工作流能够与现有的 NestJS 服务集成。

**顶级 `using` 声明**：SWC 插件现在支持在步骤和工作流函数内部使用 TC39 显式资源管理提案，从而实现自动资源清理。

**自定义类序列化**：客户端模式现在支持自定义类序列化，通过 `manifest.json` 中的 `classes` 对象来声明可序列化的类型。

**修复了 `@workflow/ai` 中工具输出的双重序列化问题**

了解更多关于 [Workflow](https://workflow.com) 的信息或[开始创建](https://docs.workflow.com/getting-started)您的第一个工作流。

---

> 本文由AI自动翻译，原文链接：[Workflow 4.1 Beta: Event-sourced architecture - Vercel](https://vercel.com/changelog/workflow-event-sourcing)
> 
> 翻译时间：2026-02-05 04:16
