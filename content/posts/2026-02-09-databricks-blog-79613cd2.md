---
title: Apache Spark实时模式：广告归因的亚秒级变革
title_original: Why Apache Spark Real-Time Mode Is A Game Changer for Ad Attribution
date: '2026-02-09'
source: Databricks Blog
source_url: https://www.databricks.com/blog/why-apache-spark-real-time-mode-game-changer-ad-attribution
author: ''
summary: Apache Spark Structured Streaming实时模式于2025年夏季发布，实现了亚秒级延迟处理。本文以广告技术为例，探讨如何结合实时模式与transformWithState功能，构建低延迟广告事件归因管道。该方案消除了对外部流处理引擎的依赖，简化了技术栈，统一了治理，并可与Databricks其他功能无缝集成。传统方案需维护庞大专用状态存储（如HBase集群），而Spark实时模式使团队能在统一平台内处理数百万并发事件，满足程序化广告对速度与精度的严苛要求。
categories:
- 技术趋势
tags:
- Apache Spark
- 实时计算
- 广告技术
- 流处理
- 数据架构
draft: false
translated_at: '2026-02-11T04:35:50.167510'
---

Apache Spark™ Structured Streaming 实时模式于2025年夏季发布，为各行业开启了亚秒级延迟的应用场景。本文探讨一个广告技术（AdTech）用例，以及如何结合实时模式和 Spark 的另一项近期增强功能（transformWithState），来实现广告事件数据的亚秒级延迟交付。

通过在低延迟用例中消除对外部流处理引擎的需求，Databricks 客户现在可以受益于简化的技术栈、统一的治理以及与其他 Databricks 功能的无缝集成。通过践行其普及数据和 AI 的使命，企业能够以更低的复杂性和风险，更快地实现业务价值。

## 用例概述

### 从沙发到点击：流媒体广告归因的瞬间世界

想象一下：你正在观看带有广告支持的最爱节目。广告插播开始的瞬间，后台会迅速展开一系列事件——基于观众画像触发广告请求、实时进行竞价拍卖、并在毫秒内交付获胜的广告创意。但投放广告仅仅是开始。

每一次广告展示都必须与下游信号（如点击、观看完成或购买）关联起来。只有当这些事件被实时关联时，广告主才能衡量真实效果并确保计费准确——这是一个对速度和精度都有极高要求的归因挑战。在程序化广告领域，有效管理广告库存需要亚秒级的延迟。

广告合同通常规定特定的展示次数（例如，一家鞋业公司希望其新广告获得一百万次家庭观看）。一旦此合同义务履行完毕，后续的广告位就可以出售给其他竞价者。这种展示匹配操作规模巨大。顶级流媒体平台处理数百万个并发的广告事件，每天经常累积数百TB的数据，同时还要遵守严格的延迟标准。

### 广告事件处理基础

现代程序化广告不仅仅是移动数据；它关乎在近乎实时的情况下关联独立、高速的事件流。一个典型的处理管道必须摄取并协调三种不同的信号：

-   **广告请求（意图）**：在用户开始播放时生成。这些数据负载包含丰富的关联键（如设备ID）以及出售广告位所需的拍卖元数据。
-   **广告展示（交付）**：当广告在观众设备上成功渲染时触发的关键"确认"信号。
-   **回调事件（结果）**：驱动计费和优化的下游交互，例如点击、观看完成或转化。

**关联挑战**：复杂性在于将这些时间上不同步的事件关联起来。这不是一个简单的无状态连接；而是一种复杂的有状态操作，必须能够：

-   **桥接异步时间线**：将"展示"与可能发生在几秒或几分钟前的"请求"进行匹配。
-   **抵御网络混乱**：优雅地处理由客户端延迟或网络分区导致的延迟到达事件。
-   **管理状态生命周期**：执行严格的过期策略（TTL 或基于计时器的状态驱逐），以防止未关闭会话导致内存膨胀。
-   **弹性扩展**：在大型体育赛事直播或节目首播期间，每秒处理数百万个事件。

### 传统实现方案

多年来，工程师们面临着一个艰难的选择：要么选择 Spark 的简洁性用于分析，要么选择专用引擎的速度用于运营。两者不可兼得。为了达到亚秒级的服务水平协议（SLA），团队被迫将零散的技术栈拼凑在一起——通常需要维护庞大的专用状态存储，仅仅是为了追踪广告展示。

**现实世界的复杂性**：一家主要的媒体提供商目前维护着一个170节点的 HBase 集群，专门用于管理其传统广告平台的状态。这不仅成本高昂，还造成了治理噩梦，运营数据与分析湖仓隔离。

## 面向运营工作负载的实时模式：Spark 的新纪元

现在，Spark 能够应对所有流处理用例。借助 Apache Spark Structured Streaming 中的实时模式（RTM），结合强大的 transformWithState 算子，我们正见证分析和运营流处理能力在一个统一平台内的融合。团队首次可以完全在 Spark 生态系统内构建复杂的低延迟广告归因管道。

### 什么是实时模式？

实时模式代表了 Spark Structured Streaming 一次根本性的架构演进。与传统的微批处理不同，实时模式在事件到达时持续处理，实现了低至个位数毫秒的 P99 延迟。Databricks 基准测试展示了卓越的性能特征：

-   **P99 延迟**：根据工作负载复杂性，从个位数毫秒到约 300 毫秒不等
-   **吞吐量**：在保持持续低延迟的同时维持高处理速率
-   **一致性**：在不同负载模式下均能提供可靠的亚秒级性能

这一突破使 Spark 能够直接与专用流处理引擎竞争，应对要求最苛刻的运营工作负载，同时保持熟悉的 DataFrame API 和丰富的生态系统集成，这正是 Spark 在分析用例中如此强大的原因。

#### 剧透预警：简洁性是最大亮点

团队只需更改一项配置即可启用实时模式——无需重写代码或更换平台——同时保持他们当前使用的相同 Structured Streaming API。您只需要应用新的触发器间隔，如下所示：

## 结合 transformWithState 的实时模式优势

`transformWithState` 算子提供了复杂事件关联所需的高级状态管理能力，这是广告归因用例的核心需求。`transformWithState` 的关键特性包括面向对象的状态管理、复合数据类型、计时器驱动逻辑、自动 TTL 支持以及模式演进。

## 代码示例：构建实时广告归因管道

### 管道架构概述

基于实时模式构建的生产级广告归因管道遵循以下高层架构：

1.  **事件摄取**：高吞吐量的 Kafka 主题接收来自分布式广告服务器和客户端应用的广告请求、展示和回调事件。
2.  **有状态关联**：`transformWithState` 算子维护关联状态，基于用户会话、广告活动标识符和时间窗口将展示与请求进行匹配。
3.  **归因逻辑**：自定义的 `StatefulProcessor` 实现应用业务规则进行归因建模，处理诸如浏览归因和多点触达归因等复杂场景。
4.  **输出生成**：匹配的归因事件被写入下游 Kafka 主题，用于实时广告活动优化和离线分析处理。

### 实现深度解析

要深入了解您可以运行并观察 RTM 性能的示例代码的技术说明，请阅读这篇 [Databricks Community 博客](https://www.databricks.com/blog)。该博客文章中的源代码生成了一个如下所示的基准测试图表，其中的数字说明了微批处理模式（MBM）与新的实时模式（RTM）之间显著的延迟差异：

### 状态管理策略

有效的广告归因需要高级的状态管理策略：

-   **请求追踪**：通过用户会话和广告活动标识符索引来维护活跃的广告请求状态，并根据归因窗口自动过期。
-   **曝光关联**：使用复合键将传入的曝光与追踪的请求进行匹配，处理多个曝光可能匹配单个请求的场景。
-   **延迟事件处理**：水印技术与有状态处理相结合，强制执行延迟到达策略，以在归因准确性、处理延迟要求和系统稳定性之间取得平衡。
-   **状态优化**：利用 `transformWithState` 实现高效的状态操作，这在事件量大的情况下尤为重要。

### 生产环境考量

#### 性能与监控

由于实时模式从根本上将执行模型从周期性的微批处理转变为连续处理，工程师必须调整其可观测性策略，将尾部延迟和稳定性置于简单平均值之上。

-   **延迟指标**：使用百分位数分布而非平均延迟来跟踪端到端处理时间。
-   **吞吐量模式**：观察不同负载条件和流量峰值下的处理速率。
-   **错误恢复**：在 `StatefulProcessor` 实现中实施适当的异常处理。

## 结论

Apache Spark™ Structured Streaming 中实时模式的引入，标志着流处理演进的一个关键时刻。企业首次能够完全在 Spark 生态系统中构建复杂的、毫秒级延迟的操作型工作负载——例如实时广告归因。

这一突破消除了长期困扰数据工程团队的架构碎片化问题。您不再需要在 Spark 的分析能力和专用引擎的操作性能之间做出选择。借助实时模式和 `transformWithState`，您可以构建统一的管道，无缝衔接分析和操作需求。

其影响超越了技术能力。团队现在可以：

-   **整合基础设施**：通过消除专用流处理引擎来减少运维开销。
-   **加速开发**：在所有流处理用例中利用现有的 Spark 专业知识。
-   **提高可靠性**：受益于 Spark 成熟的容错能力和生态系统集成。
-   **促进创新**：专注于业务逻辑，而非管理碎片化的架构。

准备好革新您的实时处理架构了吗？实时模式现已在 Databricks Runtime 16.4 LTS 及更高版本中提供**公开预览**。我们建议使用最新的 **DBR LTS** 版本，以利用最新的平台改进。立即开始构建下一代流处理应用程序，体验 Apache Spark™ 的简洁与规模所带来的毫秒级延迟处理能力。

**什么是 Apache Spark™ 中的 Structured Streaming？**
Structured Streaming 是 Apache Spark 的流处理框架，它使用与批处理工作负载相同的 DataFrame 和 Dataset API 来增量处理无界数据，并由 Spark 管理执行和容错。

**在哪里可以找到 Spark 4.0.0 及更高版本的 Structured Streaming 编程指南？**
从 Spark 4.0.0 开始，该指南已拆分为多个较小的页面，可在此处找到。

**Kafka Streams 和 Spark Structured Streaming 有什么区别？**
Kafka Streams 和 Spark Structured Streaming 是两个服务于不同用例的独立系统。Kafka Streams 是一个轻量级的流处理库，旨在构建处理存储在 Kafka 主题中数据的应用程序，通常直接嵌入在 Kafka 客户端应用程序中。Spark Structured Streaming 是一个分布式流处理引擎，专为大规模分析、有状态处理以及与 Kafka 之外的各种数据源和数据接收器（包括文件、数据库和数据湖）集成而设计。

**Spark Streaming (DStreams) 和 Apache Spark Structured Streaming 有什么区别？**
Spark Structured Streaming 是 Apache Spark 中现代且推荐的流处理引擎。它使用 DataFrame 和 Dataset API 为批处理和流处理工作负载提供统一的编程模型。基于 DStreams 的旧版 Spark Streaming API 被视为遗留技术。Spark 建议迁移到 Structured Streaming，并避免使用 DStreams 进行新的开发。

## 下一步是什么？

---

> 本文由AI自动翻译，原文链接：[Why Apache Spark Real-Time Mode Is A Game Changer for Ad Attribution](https://www.databricks.com/blog/why-apache-spark-real-time-mode-game-changer-ad-attribution)
> 
> 翻译时间：2026-02-11 04:35
