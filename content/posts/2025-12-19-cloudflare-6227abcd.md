---
title: Code Orange：构建韧性网络，让故障影响最小化
title_original: 'Code Orange: Fail Small â our resilience plan following recent incidents'
date: '2025-12-19'
source: Cloudflare Blog
source_url: https://blog.cloudflare.com/fail-small-resilience-plan/
author: Dane Knecht
summary: 'Cloudflare在近期经历两次重大网络中断后，启动了名为“Code Orange: Fail Small”的最高优先级韧性计划。该计划旨在通过三大核心措施提升网络可靠性：对配置更改实施受控的逐步推出流程，改进并测试所有流量处理系统的故障模式，以及优化内部紧急访问程序以消除循环依赖。文章承认了配置变更与软件发布在流程严谨性上的差距，并承诺将像对待核心软件更新一样，以更审慎、可监控的方式管理配置变更，从而防止因瞬时全局部署错误配置而导致的系统性故障。'
categories:
- 基础设施
tags:
- Cloudflare
- 系统可靠性
- 事故复盘
- 运维工程
- 网络基础设施
draft: false
---

2025年11月18日，Cloudflare的网络经历了约两小时十分钟的严重故障，导致网络流量无法正常交付。近三周后，即2025年12月5日，我们的网络再次出现故障，导致我们网络后28%的应用程序约25分钟无法提供服务。

在这两次事件后，我们都发布了详细的事后分析博客文章，但我们深知，要赢回您的信任，我们还需要做更多工作。今天，我们将分享Cloudflare正在开展的工作细节，以防止此类中断事件再次发生。

我们将此计划命名为"Code Orange: Fail Small"，这反映了我们的目标：让我们的网络对可能导致重大中断的错误或失误更具韧性。"Code Orange"意味着该项目的优先级高于一切。作为背景说明，我们曾在另一次需要全公司最高优先级处理的重要事件后，在Cloudflare宣布过一次"Code Orange"。我们认为近期的事件需要同样的关注度。Code Orange是我们的实现方式，它允许团队在必要时跨职能协作以完成任务，同时暂停任何其他工作。

Code Orange工作主要分为三个领域：
1.  要求对任何传播到网络的配置更改进行受控的逐步推出，就像我们今天对软件二进制版本发布所做的那样。
2.  审查、改进和测试所有处理网络流量的系统的故障模式，以确保它们在所有条件下（包括意外的错误状态）都表现出明确的行为。
3.  更改我们内部的"紧急访问"*程序，并消除任何循环依赖，以便我们和我们的客户在事件期间能够快速行动并无障碍地访问所有系统。

这些项目将在进行过程中提供迭代改进，而不是在结束时进行"大爆炸"式的一次性更改。每一次单独的更新都将为Cloudflare带来更强的韧性。最终，我们期望Cloudflare的网络韧性将大大增强，包括应对那些在过去两个月引发我们经历的全球性事件的问题。

我们理解这些事件对我们的客户乃至整个互联网都是痛苦的。我们对此深感惭愧，这也是为什么这项工作成为Cloudflare每一位员工的首要任务。

* Cloudflare的"紧急访问"程序允许特定人员在特定情况下提升其权限，以执行紧急操作来解决高严重性场景。

在第一次事件中，访问Cloudflare上客户站点的用户看到了错误页面，表明Cloudflare无法响应他们的请求。在第二次事件中，他们看到了空白页面。

两次中断都遵循了类似的模式。在每次事件发生前的瞬间，我们在全球数百个城市的数据中心瞬时部署了一项配置更改。

11月的更改是对我们的Bot Management分类器进行的自动更新。我们运行各种人工智能模型，这些模型从流经我们网络的流量中学习，以构建识别机器人的检测机制。我们不断更新这些系统，以领先于试图绕过我们的安全防护访问客户站点的恶意行为者。

在12月的事件中，为了保护客户免受流行的开源框架React中一个漏洞的影响，我们部署了一项更改到安全分析师使用的安全工具上，以改进我们的签名。与新的机器人管理更新的紧迫性类似，我们需要领先于想要利用该漏洞的攻击者。正是这项更改触发了事件的开始。

这种模式暴露了我们在Cloudflare部署配置更改的方式与发布软件更新的方式之间存在严重差距。当我们发布软件版本更新时，我们以受控和监控的方式进行。对于每个新的二进制版本，部署必须成功通过多个关卡，才能为全球流量提供服务。我们首先向员工流量部署，然后谨慎地将更改逐步推广给全球越来越多的客户，从免费用户开始。如果我们在任何阶段检测到异常，我们可以在无需人工干预的情况下回滚发布。

我们尚未将这种方法应用于配置更改。与发布驱动我们网络的核心软件不同，当我们进行配置更改时，我们是在修改该软件行为的参数值，并且我们可以立即完成。我们也赋予客户这种能力：如果您更改Cloudflare中的某项设置，它将在几秒钟内传播到全球。

虽然这种速度有优势，但也伴随着我们需要解决的风险。过去两次事件表明，我们需要以与对待软件本身更改相同的、经过测试的谨慎程度，来对待应用于我们网络中流量服务方式的任何更改。

我们将改变在Cloudflare部署配置更新的方式
在几秒钟内全球部署配置更改的能力是这两次事件的核心共同点。在这两次事件中，一个错误的配置都在几秒钟内使我们的网络瘫痪。

引入对我们配置的受控逐步推出，就像我们已经对软件发布所做的那样，是我们Code Orange计划中最重要的任务流。

Cloudflare的配置更改会非常快速地传播到网络。当用户创建新的DNS记录或新的安全规则时，它会在几秒钟内到达网络上90%的服务器。这由一个我们内部称为Quicksilver的软件组件驱动。

Quicksilver也用于我们自身团队所需的任何配置更改。速度是其特点：我们可以非常快速地做出反应并全局更新我们的网络行为。然而，在这两次事件中，这导致了一个破坏性更改在几秒钟内传播到整个网络，而不是通过关卡进行测试。

虽然近乎即时地向我们的网络部署更改的能力在许多情况下很有用，但很少是必需的。目前正在进行的工作是将配置视为与代码相同，通过在Quicksilver中为任何配置更改引入受控部署。

我们每天通过所谓的健康中介部署系统多次向我们的网络发布软件更新。在这个框架下，Cloudflare中拥有服务（部署到我们网络中的一段软件）的每个团队都必须定义指示部署成功或失败的指标、推出计划以及如果未成功应采取的措施。

不同的服务会有略微不同的变量。有些在推进到更多数据中心之前可能需要更长的等待时间，而另一些可能对错误率的容忍度较低，即使这会导致误报信号。

一旦部署，我们的HMD工具包就会开始根据该计划谨慎推进，并在继续之前监控每个步骤。如果任何步骤失败，回滚将自动开始，并在需要时通知相关团队。

到Code Orange结束时，配置更新将遵循同样的流程。我们期望这将使我们能够在过去两次事件中出现的问题演变成广泛问题之前，就快速发现它们。

我们将如何解决服务之间的故障模式？
虽然我们乐观地认为，更好地控制配置更改将在更多问题演变成事件之前发现它们，但我们知道错误可能并且将会发生。在这两次事件中，我们网络某一部分的错误都演变成了我们大部分技术栈的问题，包括客户依赖以配置其使用Cloudflare方式的控制平面。

我们需要考虑的不仅仅是地理层面的逐步推进（扩展到更多数据中心）或用户群体层面的逐步推进（扩展到员工和客户类型）。

我们还需要规划更安全的部署方案，以遏制故障在服务间的蔓延（例如从Bot Management服务扩散至仪表盘等不相关的产品）。

为此，我们正在审查构成我们网络的每个关键产品与服务间的接口契约，以确保：a) 预设每个接口都可能发生故障；b) 以最合理的方式处理这些故障。

回顾Bot Management服务故障，至少存在两个关键接口——如果我们预设故障会发生，本可以妥善处理到几乎不影响任何客户的程度。第一个是读取损坏配置文件的接口。系统本不应直接崩溃，而应设置一套经过验证的合理默认值，这样流量仍能通过我们的网络传输，最坏情况也仅是影响用于机器人检测机器学习模型的实时微调数据。

第二个接口位于网络核心软件与Bot Management模块之间。当机器人管理模块发生故障（如本次情况）时，我们不应默认丢弃流量，而应再次设定更合理的默认方案，允许流量在获得基本分类的情况下通过。

**如何加快紧急事件处理速度？**

在事件处理过程中，我们解决问题耗时过长。这两次事件中，安全系统阻止团队成员访问修复问题所需的工具加剧了情况恶化，某些内部系统的循环依赖也导致处理速度进一步降低。

作为安全公司，我们所有工具都置于具有细粒度访问控制的多层身份验证之后，以确保客户数据安全并防止未授权访问。这种做法本身是正确的，但在速度至关重要的紧急时刻，现有流程和系统却拖慢了响应速度。

循环依赖也影响了客户体验。例如在11月18日的事件中，我们的无验证码机器人解决方案Turnstile变得不可用。由于Cloudflare仪表盘登录流程使用了Turnstile，没有活跃会话或API服务令牌的客户在最需要登录进行关键配置变更时无法访问系统。

我们的团队将审查并改进所有应急流程与技术，确保在必要时能快速获取所需工具，同时满足安全要求。这包括审查并消除循环依赖，或在事件发生时快速"绕过"这些依赖。我们还将增加演练频率，确保所有团队在未来潜在危机场景前充分理解处理流程。

尽管本文未涵盖所有内部工作，但上述工作流已描述了团队当前的重点任务。每项工作流都对应着涉及Cloudflare几乎所有产品和工程团队的详细计划。我们任重道远。

在第一季度末（且大部分工作将提前完成），我们将：
- 确保所有生产系统配置管理均采用健康监测部署（HMD）机制
- 更新各产品系统以遵循适当的故障处理模式
- 建立完善的应急流程，确保相关人员能在紧急情况下获得适当权限进行有效处置

部分目标将持续推进：随着新软件发布，我们需要不断优化循环依赖处理；应急流程也需随安全技术演进持续更新。

在这两次事件中，我们辜负了用户和整个互联网社区的信任。我们将全力改进以弥补过失。我们计划在工作推进过程中持续分享进展，并衷心感谢客户与合作伙伴提出的问题与反馈。

---

> 本文由AI自动翻译，原文链接：[Code Orange: Fail Small â our resilience plan following recent incidents](https://blog.cloudflare.com/fail-small-resilience-plan/)
> 
> 翻译时间：2026-01-04 23:58
