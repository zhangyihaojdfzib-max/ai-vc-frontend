---
title: Discord将端到端加密协议DAVE扩展至全平台
title_original: Bringing DAVE to All Discord Platforms
date: '2025-09-02'
source: Discord Engineering
source_url: https://discord.com/blog/bringing-dave-to-all-discord-platforms
author: ClÃ©ment Brisset
summary: Discord宣布将其端到端加密协议DAVE的支持范围扩展至所有平台，包括浏览器、游戏主机和社交SDK，并计划于2026年3月1日完全淘汰非E2EE通话。文章重点介绍了在浏览器端实现DAVE所面临的技术挑战，包括利用WebRTC编码转换API、通过Web
  Worker处理加密解密操作，以及将经过验证的C++代码库编译为WebAssembly以确保安全性和性能。文中还分享了与Mozilla合作解决Firefox兼容性问题的经历。
categories:
- 技术趋势
tags:
- 端到端加密
- WebRTC
- Discord
- WebAssembly
- 浏览器技术
draft: false
---

去年，我们推出了DAVE协议，作为为Discord语音和视频通话提供端到端加密（简称"E2EE"）的解决方案。自那时起，DAVE每天为数千万次Discord通话提供E2EE保护。今天，我们很高兴地宣布，我们将把DAVE支持扩展到所有剩余平台，包括浏览器、游戏主机和我们的社交SDK。

从2026年3月1日开始，不支持DAVE的客户端和应用程序将无法再参与Discord通话。这将标志着我们从去年的实验性推广，到将DAVE确立为Discord语音和视频通话标准的完整过渡。

在本文中，我们将探讨将DAVE集成到Web浏览器时遇到的技术挑战和权衡，从WebAssembly性能考量到Web Worker架构决策。我们还将分享更多关于我们淘汰非E2EE通话的时间表，以及您或您的应用程序在2026年3月1日之后仍能连接到语音频道可能需要采取的措施。

**浏览器支持的技术挑战**

从一开始，我们设计DAVE时就考虑了Web浏览器，确保它能支持与其他平台同样广泛的视频编解码器。从一开始就进行这样的规划，将确保更好的视频通话体验，因为现代设备为H.265和AV1等编解码器提供了出色的硬件支持，从而为用户带来更好的视频质量和更高的带宽利用效率。

**编码转换API**

正如我们之前的博客文章所提到的，使用WebRTC编码转换API是在Web浏览器上支持DAVE的关键选择。

本质上，该API允许我们在WebRTC管道内部对音频和视频数据进行端到端加密。

在为各浏览器添加WebRTC编码转换API支持的过程中，我们在Firefox上遇到了一个意想不到的挑战。最初的概念验证运行良好，DAVE的加密功能在受控测试中按预期工作。然而，当我们在真实的Discord通话中尝试使用DAVE时，它却停止了工作。负责加密的Web Worker没有从WebRTC编码转换API接收到任何数据。

在通过我们的应用程序栈进行广泛调试未能解决问题后，我们决定从源代码构建Firefox，以便在浏览器层面进行调查。就在那时，我们发现了一个小的边界情况：在Firefox中支持RTCRtpScriptTransform的FrameTransformerProxy，当视频数据过早地馈送到转换器时，可能会发生死锁。视频数据被存储起来进行延迟处理，而延迟处理发生在互斥锁下，该互斥锁又被转换操作再次访问，从而导致递归死锁。

我们对Mozilla在整个过程中的响应速度印象深刻。事实证明，构建和浏览Firefox代码库出人意料地简单，整个过程——从下载代码库到提交我们的补丁——只花了一天多一点的时间。Mozilla迅速回应了我们的提交，经过几轮实现调整后，补丁被合并了！这些修复现在已在Firefox v142.0中提供，这将是Firefox上使用DAVE所需的最低版本。

**利用Web Worker进行加密**

每个Discord连接都使用一个专用的Web Worker来处理媒体流的加密和解密，然后再将其交还给将执行编码或解码的Web浏览器。对于Discord通话，一个Worker处理通话中音频和摄像头视频的加密和解密，而单独的Worker则处理关联的屏幕共享和游戏流中音频和视频流的相同操作。

每个WebRTC音频和视频流都有一个唯一的SSRC（同步源标识符），随每一帧传输。使用DAVE时，我们利用这个SSRC来识别对每一帧使用哪个对称加密密钥。每个Web Worker仅维护通话的必要上下文：传入和传出的音频和视频数据、SSRC到用户ID的映射，以及每个用户的加密密钥。这种设计使Worker保持轻量级，并仅专注于加密操作。

JavaScript主线程管理WebRTC连接，跟踪通话中的用户及其不同的媒体轨道。主线程还在用户加入或离开通话时处理消息层安全协议（MLS）协商。这种分离对性能至关重要，因为MLS群组变更可以立即进行，无需往返Worker（Worker可能需要先完成一帧的加密），从而最大限度地减少了成员加入和离开时的延迟。

每当MLS会话发生变化时，例如用户加入或离开通话，主线程会向Worker发送消息以更新其加密状态。这种异步方法确保了在处理群组成员变更的同时，加密操作能够平稳进行。

**通过WebAssembly复用经过验证的代码**

我们的DAVE实现已经在Discord的整个生态系统中经过了实战测试，在桌面和移动设备上处理了数十亿次加密通话。通过将相同的C++代码库编译为WebAssembly，我们消除了可能危及安全性或性能的平台特定错误的风险。这不仅仅是代码复用，更是部署已经在Discord日常大规模使用中证明其可靠性的加密逻辑。

加密过程需要仔细考虑，以保持WebRTC打包器所需的元数据不被加密。一旦数据离开加密器，在到达解密器之前不能以任何方式修改，否则解密将失败。为了实现这一点，加密器需要输出能够通过WebRTC打包器、选择性转发单元和WebRTC解包器而保持原样的数据。

这种字节级解析和选择性加密在计算上是密集型的，并且实现起来容易出错。WebAssembly为这些操作提供了接近原生的性能，同时避免了用JavaScript重新实现此逻辑的复杂性和潜在错误。

**性能权衡：WebAssembly vs. SubtleCrypto**

虽然WebAssembly在帧解析方面带来了显著优势，但与SubtleCrypto等原生浏览器API相比，我们在加密操作方面确实付出了最小的性能代价。然而，我们的基准测试揭示了这些权衡中令人惊讶的细微差别：

-----------------------------------------------------
基准测试         时间     迭代次数
-----------------------------------------------------
DaveWasm/256     3 us     305400
DaveWasm/1024    10 us    99000
DaveWasm/8192    74 us    13600
DaveWasm/16384   146 us   6900
SubtleCrypto/256 4 us     236100
SubtleCrypto/1024 6 us    155500
SubtleCrypto/8192 25 us   39700
SubtleCrypto/16384 46 us  21900
â

音频加密比SubtleCrypto快28%。音频帧通常很小（通常在~150字节左右），调用SubtleCrypto异步API的开销超过了硬件加速带来的性能优势。

相反，视频加密性能比SubtleCrypto慢192%。

较大的视频帧（通常在2KB至8KB之间）受益显著，这得益于通过SubtleCrypto提供的硬件加速AES指令。

**为何WebAssembly是我们的正确选择**
尽管视频加密存在性能损耗，WebAssembly仍为Discord的混合工作负载提供了最优解决方案：
- **更低的音频延迟**：WASM在音频处理上28%的性能优势直接转化为处理延迟的降低，这对维持Discord的实时音频质量至关重要
- **统一架构**：在同一执行上下文中管理整个转换过程，消除了JavaScript与原生API间昂贵的边界跨越开销
- **编解码器兼容性**：复杂的解析逻辑若用JavaScript高效实现将十分困难且易出错
- **未来改进空间**：WASM的SharedArrayBuffer内存机制为未来直接从WASM调用SubtleCrypto打开了大门，这将使我们兼得两者优势

**安全审计**
继此前与Trail of Bits就DAVE协议的初始设计评审和实现评审开展合作后，我们再次委托他们对DAVE的新变更及新的网页浏览器集成进行审计。您可在此查看其最新审计结果。

我们的漏洞赏金计划仍对涉及DAVE协议的成功漏洞报告提供现金奖励。

**游戏主机支持、Discord社交SDK与舞台频道**
Xbox对DAVE的支持已启动，并将在未来几个月内逐步启用。您在Xbox One或Xbox Series S|X主机上的下一次Discord通话可能已实现端到端加密！

PlayStation对DAVE的支持将在其下次系统更新后逐步启用。

Discord社交SDK内置DAVE支持，开发者无需额外操作。

舞台频道是Discord上独特的互动环境，少数用户向大量用户进行"广播"。由于其更具公开性，且采用为大规模参与者扩展而构建的不同架构，这些频道将继续使用客户端与服务器间的传输加密，但不会采用端到端加密。

**逐步淘汰非端到端加密通话**
我们于两年前启动Discord端到端加密工作，以提升用户隐私与安全性。随着DAVE现已支持全平台，我们距离实现所有通话完全端到端加密已非常接近。

为支持我们的长期隐私目标，自2026年3月1日起，Discord将仅支持在私信（DM）、群组消息（GDM）、语音频道及Go Live直播中的所有音视频通话采用端到端加密。此后，任何未更新支持DAVE的客户端或应用程序将无法再参与Discord通话。

此时间表为用户留出了安装最新Discord客户端的时间，有助于确保完全兼容DAVE并平稳过渡至我们的端到端加密基础设施。如果您经常关闭或重启应用，很可能已完成准备。

我们致力于在向所有Discord用户提供DAVE增强隐私与安全性的同时，尽可能平稳地完成此次过渡。

---

> 本文由AI自动翻译，原文链接：[Bringing DAVE to All Discord Platforms](https://discord.com/blog/bringing-dave-to-all-discord-platforms)
> 
> 翻译时间：2026-01-06 04:31
