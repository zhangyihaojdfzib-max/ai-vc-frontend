---
title: Cloudflare R2推出本地化上传功能，全球上传性能提升75%
title_original: Improve global upload performance with R2 Local Uploads
date: '2026-02-03'
source: Cloudflare Blog
source_url: https://blog.cloudflare.com/r2-local-uploads/
author: ''
summary: Cloudflare正式推出R2对象存储的本地化上传功能公开测试版。该功能允许数据先写入靠近客户端的存储位置，再异步复制到存储桶主区域，实现数据强一致性与即时访问。测试显示，跨区域上传请求的末字节时间最多可减少75%，显著优化了全球用户或设备上传媒体、日志等场景的性能。用户可通过控制台或Wrangler命令一键启用。
categories:
- AI基础设施
tags:
- Cloudflare
- 对象存储
- 性能优化
- 全球网络
- R2
draft: false
translated_at: '2026-02-04T04:21:01.375168'
---

# 通过R2本地化上传提升全球上传性能

2026-02-03

- Frank Chen
- Rahul Suresh
- Anni Wang

![](/images/posts/5585ba23e052.png)

今天，我们正式推出R2本地化上传功能的公开测试版。启用本地化上传后，对象数据会先自动写入靠近客户端的存储位置，随后异步复制到存储桶所在区域。数据可立即访问并保持强一致性。上传速度更快，数据实现全球化感知。

对许多应用而言，性能需要具备全球性。例如用户从不同区域上传媒体内容，或设备从世界各地发送日志和遥测数据。但数据必须存储在某个位置，这意味着远距离上传需要跨越整个网络距离才能到达您的存储桶。

R2是基于Cloudflare全球网络构建的对象存储服务。开箱即用，它能自动在全球缓存对象数据以实现快速读取——同时保持强一致性和零出口费用。无论您使用S3 API、Workers绑定还是普通HTTP，这一切都在后台自动完成。现在通过本地化上传，全球任意地点的读写操作都能获得高速体验。

您可以通过此演示亲自体验本地化上传的优势。

准备尝试了吗？您可以在Cloudflare控制台的存储桶设置中启用本地化上传，或通过一条Wrangler命令为现有存储桶启用该功能。

```Shell
npx wrangler r2 bucket local-uploads enable [BUCKET]
```

## 全球上传总请求时长降低75%

本地化上传能加速上传请求（即PutObject、UploadPart）。在客户私测和我们的合成基准测试中，当上传请求与存储桶位于不同区域时，末字节时间最多可减少75%。这些结果中，TTLB的测量从R2接收上传请求开始，到R2返回200响应为止。

在我们的合成测试中，我们通过模拟跨区域上传工作流的合成负载来评估本地化上传的影响。我们在北美西部部署测试客户端，并配置了亚太区域提示的R2存储桶。该客户端在30分钟内以每秒约20个PutObject请求的速度上传5MB大小的对象。

下图比较了这些请求的p50（中位数）TTLB指标，展示了上传请求时长的差异——首先是未启用本地化上传的情况（TTLB约2秒），然后是启用本地化上传的情况（TTLB约500毫秒）：

## 工作原理：距离问题

要理解本地化上传如何改善上传请求，我们首先需要了解R2的工作原理。R2架构由多个组件构成，包括：

- R2网关Worker：处理所有API请求的入口点，负责身份验证和路由逻辑。它通过Cloudflare Workers部署在Cloudflare全球网络中。
- 持久化对象元数据服务：基于持久化对象构建的分布式层，用于存储和管理对象元数据（如对象键、校验和）。
- 分布式存储基础设施：持久存储加密对象数据的基础架构。

R2网关Worker：处理所有API请求的入口点，负责身份验证和路由逻辑。它通过Cloudflare Workers部署在Cloudflare全球网络中。

持久化对象元数据服务：基于持久化对象构建的分布式层，用于存储和管理对象元数据（如对象键、校验和）。

分布式存储基础设施：持久存储加密对象数据的基础架构。

未启用本地化上传时，向存储桶上传对象的过程如下：请求首先由靠近用户的R2网关接收并进行身份验证。随后，当客户端流式传输对象数据字节时，数据会被加密并写入存储桶所在区域的存储基础设施中。完成此操作后，网关会联系元数据服务发布对象元数据，并在提交后向客户端返回成功响应。

如果客户端与存储桶位于不同区域，由于请求需要传输更远距离，对象数据字节的上传过程可能会引入更多可变性。这可能导致上传速度变慢或可靠性降低。

未启用本地化上传时，从北美东部上传至东欧存储桶的客户端。

现在，当您向启用本地化上传的存储桶发起上传请求时，系统会处理两种情况：

1. 客户端与存储桶区域位于相同区域
2. 客户端与存储桶区域位于不同区域

客户端与存储桶区域位于相同区域

客户端与存储桶区域位于不同区域

第一种情况下，R2遵循常规流程，将对象数据写入存储桶的存储基础设施。第二种情况下，R2将数据写入客户端所在区域的存储基础设施，同时仍将对象元数据发布到存储桶区域。

重要的是，对象在初始写入完成后即可立即访问。在整个复制过程中对象始终保持可访问状态——无需等待后台复制完成即可读取对象。

启用本地化上传后，从北美东部上传至东欧存储桶的客户端。

请注意，此功能适用于非管辖限制的存储桶，对于启用了管辖限制（如欧盟、FedRAMP）的存储桶不可用。

## 适用场景

本地化上传专为接收大量来自与存储桶所在地理区域不同的上传请求的工作负载而设计。以下场景最适合使用此功能：

- 您的用户全球分布
- 上传性能和可靠性对您的应用至关重要
- 您希望在不更改存储桶主要位置的情况下优化写入性能

您的用户全球分布

上传性能和可靠性对您的应用至关重要

您希望在不更改存储桶主要位置的情况下优化写入性能

要了解读写请求发起的地理分布情况，您可以访问Cloudflare控制台，进入R2存储桶的指标页面，查看按区域划分的请求分布图。

## 技术实现原理

通过本地化上传，对象数据先写入靠近客户端的位置，随后在后台复制到存储桶区域。我们将此复制任务称为复制任务。

针对这些复制任务，我们需要一个异步处理组件，这恰好是Cloudflare队列的绝佳用例。队列允许我们控制处理复制任务的速率，并提供内置的故障处理能力，如重试和死信队列。在此架构中，R2将复制任务按存储区域分片到多个队列中。

### 元数据发布与复制调度

启用本地化上传后发布对象元数据时，我们以原子操作执行三个步骤：

1. 存储对象元数据
2. 创建跟踪待完成复制的待处理副本键
3. 创建按时间戳索引的复制任务标记键，用于控制任务发送至队列的时机

存储对象元数据

创建跟踪待完成复制的待处理副本键

创建按时间戳索引的复制任务标记键，用于控制任务发送至队列的时机

待处理副本键包含完整的复制计划：复制任务数量、读取源位置、写入目标位置、复制模式和优先级，以及复制成功后是否删除源数据。

这使我们在移动对象数据时具有灵活性。例如，跨长地理距离移动数据成本高昂。我们可以尝试通过并行处理所有副本来尽快移动它们，但这会产生更高的成本并对网络基础设施造成压力。相反，我们通过首先在目标存储桶区域创建一个副本，然后使用此本地副本在存储桶区域内创建其他副本，从而最大限度地减少跨区域数据移动的次数。

一个后台进程会定期扫描复制任务标记，并将其发送到与目标存储区域关联的队列之一。这些标记保证任务至少被传送到队列一次——如果入队失败或进程崩溃，标记会持续存在，任务将在下一次扫描时重试。这也允许我们在不同时间处理复制任务，并且只将有效任务加入队列。一旦复制任务到达队列，它就可以被处理了。

### 异步复制：拉取模型

对于队列消费者，我们选择了拉取模型，其中一个集中式轮询服务从区域队列中消费任务，并将其分派给网关工作器执行。

其工作原理如下：

1.  **轮询服务从区域队列拉取任务**：消费者服务轮询区域队列以获取复制任务。然后，它根据要移动的数据量对任务进行批处理，以创建统一的批次大小。
2.  **轮询服务分派任务给网关工作器**：消费者服务将复制作业发送给网关工作器。
3.  **网关工作器执行复制**：工作器从源位置读取对象数据，将其写入目标位置，并更新持久对象中的元数据，可选地将源位置标记为待垃圾回收。
4.  **网关工作器报告结果**：完成后，工作器将结果返回给轮询器，轮询器向队列确认任务已完成或失败。

通过使用这种拉取模型方法，我们确保复制过程保持稳定和高效。该服务可以根据实时系统健康状况动态调整其处理速度，保证数据安全地跨区域复制。

## 立即试用

本地上传功能现已开放公测。启用本地上传**无需额外费用**。启用此功能后发出的上传请求会产生标准的A类操作成本，与未启用本地上传时发出的上传请求相同。

要开始使用，请访问Cloudflare仪表板，在您的存储桶设置下找到"本地上传"卡片并启用，或者直接使用Wrangler运行以下命令来为存储桶启用本地上传。

```Shell
npx wrangler r2 bucket local-uploads enable [BUCKET]
```

为存储桶启用本地上传是无缝的：现有的上传将按预期完成，并且不会中断流量。

更多信息，请参阅[本地上传文档](https://developers.cloudflare.com/r2/buckets/local-uploads/)。如果您有任何问题或想分享反馈，请加入我们的[开发者Discord](https://discord.com/invite/cloudflaredev)讨论。

---

> 本文由AI自动翻译，原文链接：[Improve global upload performance with R2 Local Uploads](https://blog.cloudflare.com/r2-local-uploads/)
> 
> 翻译时间：2026-02-04 04:21
